<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAPPY BINGO PRO</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Poppins:wght@400;700&display=swap');

        :root {
            /* Default: Neon Night (Dark) */
            --bg: #0f172a; --card: #1e293b; --text: #f8fafc;
            --p1: #00f2ff; --p2: #ff007b; --accent: #f1c40f; --cell: #334155;
        }

        [data-theme="space"] { /* Dark 2 */
            --bg: #1a1a2e; --card: #16213e; --text: #e94560;
            --p1: #0f3460; --p2: #e94560; --accent: #ffffff; --cell: #0f3460;
        }

        [data-theme="forest"] { /* Dark 3 */
            --bg: #052c05; --card: #0a3d0a; --text: #dcfce7;
            --p1: #22c55e; --p2: #fbbf24; --accent: #ffffff; --cell: #14532d;
        }

        [data-theme="paper"] { /* Light 1 */
            --bg: #f8fafc; --card: #ffffff; --text: #1e293b;
            --p1: #3b82f6; --p2: #ef4444; --accent: #f59e0b; --cell: #f1f5f9;
        }

        [data-theme="sky"] { /* Light 2 */
            --bg: #e0f2fe; --card: #ffffff; --text: #0369a1;
            --p1: #0ea5e9; --p2: #ec4899; --accent: #8b5cf6; --cell: #f0f9ff;
        }

        [data-theme="mint"] { /* Light 3 */
            --bg: #f0fdf4; --card: #ffffff; --text: #166534;
            --p1: #10b981; --p2: #f97316; --accent: #3b82f6; --cell: #dcfce7;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Poppins', sans-serif; }
        body { background: var(--bg); color: var(--text); min-height: 100vh; transition: 0.3s; }

        .container { max-width: 500px; margin: 0 auto; padding: 20px; }
        .screen { display: none; animation: fadeIn 0.3s; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: var(--card); padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center; }
        h1 { font-family: 'Orbitron'; font-size: 2rem; margin-bottom: 20px; color: var(--accent); }

        .btn { width: 100%; padding: 14px; margin: 10px 0; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; transition: 0.2s; text-transform: uppercase; }
        .btn-p1 { background: var(--p1); color: white; }
        .btn-p2 { background: var(--p2); color: white; }
        .btn-accent { background: var(--accent); color: #000; }
        
        input, select { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid rgba(0,0,0,0.1); background: var(--cell); color: var(--text); }

        /* Game Elements */
        .game-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .timer-container { width: 100%; height: 8px; background: rgba(0,0,0,0.1); border-radius: 4px; margin-bottom: 15px; overflow: hidden; }
        #timerBar { width: 100%; height: 100%; background: var(--accent); transition: width 1s linear; }

        .happy-box { display: flex; gap: 4px; justify-content: center; }
        .letter { width: 30px; height: 30px; background: rgba(0,0,0,0.1); border-radius: 5px; display: flex; align-items: center; justify-content: center; font-weight: 900; opacity: 0.2; font-size: 0.8rem; }
        
        @keyframes fall { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .letter.active { opacity: 1; animation: fall 0.5s forwards; color: #fff; }
        .p1-lit { background: var(--p1) !important; box-shadow: 0 0 10px var(--p1); }
        .p2-lit { background: var(--p2) !important; box-shadow: 0 0 10px var(--p2); }

        .board { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
        .cell { aspect-ratio: 1; background: var(--cell); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.2rem; cursor: pointer; transition: 0.2s; border: 2px solid transparent; }
        
        .cell.struck-p1 { background: var(--p1) !important; color: white !important; transform: scale(0.95); box-shadow: inset 0 0 10px rgba(0,0,0,0.3); }
        .cell.struck-p2 { background: var(--p2) !important; color: white !important; transform: scale(0.95); box-shadow: inset 0 0 10px rgba(0,0,0,0.3); }

        .room-footer { margin-top: 20px; font-size: 0.8rem; cursor: pointer; opacity: 0.7; }

        /* Overlays */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .overlay.active { display: flex; }
        .reveal-grids { display: flex; gap: 20px; margin: 20px 0; width: 100%; overflow-x: auto; }
        .mini-board { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; width: 180px; }
        .mini-cell { width: 32px; height: 32px; font-size: 0.7rem; background: var(--cell); border-radius: 4px; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body data-theme="neon">

    <div class="container">
        <!-- Landing -->
        <div id="screen-landing" class="screen active">
            <div class="card">
                <h1>HAPPY BINGO</h1>
                <p style="margin-bottom: 15px; opacity: 0.7;">Choose a Theme</p>
                <select id="themePicker" onchange="setTheme(this.value)">
                    <optgroup label="Dark Themes">
                        <option value="neon">Neon Night</option>
                        <option value="space">Deep Space</option>
                        <option value="forest">Midnight Forest</option>
                    </optgroup>
                    <optgroup label="Light Themes">
                        <option value="paper">Classic Paper</option>
                        <option value="sky">Blue Sky</option>
                        <option value="mint">Fresh Mint</option>
                    </optgroup>
                </select>
                <button class="btn btn-p1" onclick="startOffline()">Offline 1v1</button>
                <button class="btn btn-p2" onclick="openOnlineMenu()">Online Multiplayer</button>
            </div>
        </div>

        <!-- Online Menu -->
        <div id="screen-online" class="screen">
            <div class="card">
                <input type="text" id="playerName" placeholder="Enter Name (e.g. Water)">
                <button class="btn btn-p1" onclick="createRoom()">Create Room</button>
                <div style="margin: 15px 0; opacity: 0.3;">OR</div>
                <input type="text" id="joinID" placeholder="Enter Room Code">
                <button class="btn btn-p2" onclick="joinRoom()">Join Room</button>
                <button class="btn" onclick="showScreen('landing')">Back</button>
            </div>
        </div>

        <!-- Game -->
        <div id="screen-game" class="screen">
            <div class="timer-container"><div id="timerBar"></div></div>
            <div class="game-info">
                <div>
                    <span id="name-p1" style="font-weight: 700; color: var(--p1);">Water</span>
                    <div class="happy-box" id="happy-p1">
                        <div class="letter">H</div><div class="letter">A</div><div class="letter">P</div><div class="letter">P</div><div class="letter">Y</div>
                    </div>
                </div>
                <div id="turn-msg" style="font-family: Orbitron; font-size: 0.9rem;">WAITING...</div>
                <div style="text-align: right;">
                    <span id="name-p2" style="font-weight: 700; color: var(--p2);">Fire</span>
                    <div class="happy-box" id="happy-p2">
                        <div class="letter">H</div><div class="letter">A</div><div class="letter">P</div><div class="letter">P</div><div class="letter">Y</div>
                    </div>
                </div>
            </div>

            <div class="board" id="mainBoard"></div>
            <div class="room-footer" id="roomDisp" onclick="copyCode()"></div>
        </div>
    </div>

    <!-- Reveal Overlay -->
    <div class="overlay" id="overlay-reveal">
        <h1 id="win-status">WINNER!</h1>
        <div class="reveal-grids">
            <div><p id="rev-name-p1"></p><div class="mini-board" id="rev-board-p1"></div></div>
            <div><p id="rev-name-p2"></p><div class="mini-board" id="rev-board-p2"></div></div>
        </div>
        <button class="btn btn-accent" onclick="exitGame()" style="width: 200px;">Exit to Menu</button>
    </div>

    <!-- Error Overlay -->
    <div class="overlay" id="overlay-error">
        <h2 style="color: var(--p2);">CONNECTION LOST</h2>
        <p>Checking network...</p>
    </div>

    <script>
        // --- FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyD9TdgANtxXcp9rM8zLKBSsxWWla0y3MdY",
            authDomain: "bingo-f9c68.firebaseapp.com",
            databaseURL: "https://bingo-f9c68-default-rtdb.firebaseio.com",
            projectId: "bingo-f9c68",
            storageBucket: "bingo-f9c68.firebasestorage.app",
            messagingSenderId: "147698658087",
            appId: "1:147698658087:web:7180b36507f4e81801d702"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- STATE ---
        let state = {
            mode: 'off', role: 'p1', turn: 'p1', 
            p1Name: 'Water', p2Name: 'Fire',
            p1Grid: [], p2Grid: [], struck: [],
            roomID: null, timer: 30, timerIdx: null
        };

        const winLines = [
            [0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],
            [0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],
            [0,6,12,18,24],[4,8,12,16,20]
        ];

        // --- UI HELPERS ---
        function setTheme(t) { document.body.setAttribute('data-theme', t); }
        function showScreen(s) {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById('screen-' + s).classList.add('active');
        }
        function copyCode() {
            if(!state.roomID) return;
            navigator.clipboard.writeText(state.roomID);
            alert("Room Code Copied!");
        }

        // --- GAME LOGIC ---
        function startOffline() {
            state.mode = 'off';
            state.p1Grid = [...Array(25).keys()].map(i => i + 1).sort(() => Math.random() - 0.5);
            state.p2Grid = state.p1Grid;
            initUI();
        }

        function openOnlineMenu() { showScreen('online'); }

        function createRoom() {
            const name = document.getElementById('playerName').value || "Water";
            state.roomID = Math.random().toString(36).substring(2, 7).toUpperCase();
            state.role = 'p1'; state.p1Name = name; state.mode = 'on';

            const g1 = [...Array(25).keys()].map(i => i + 1).sort(() => Math.random() - 0.5);
            const g2 = [...Array(25).keys()].map(i => i + 1).sort(() => Math.random() - 0.5);

            const ref = db.ref('rooms/' + state.roomID);
            ref.set({
                p1: { name, grid: g1 },
                p2: { name: "Waiting...", grid: g2 },
                struck: [0], turn: 'p1', status: 'waiting'
            });

            ref.onDisconnect().remove(); 
            listenRoom();
            initUI();
        }

        function joinRoom() {
            const code = document.getElementById('joinID').value.toUpperCase();
            const name = document.getElementById('playerName').value || "Fire";
            if(!code) return;

            db.ref('rooms/' + code).once('value', snap => {
                if(!snap.exists()) return alert("Room not found!");
                state.roomID = code; state.role = 'p2'; state.p2Name = name; state.mode = 'on';
                db.ref('rooms/' + code).update({ 
                    'p2/name': name, status: 'playing' 
                });
                db.ref('rooms/' + code).onDisconnect().remove();
                listenRoom();
                initUI();
            });
        }

        function listenRoom() {
            db.ref('rooms/' + state.roomID).on('value', snap => {
                const data = snap.val();
                if(!data) return handleDisconnect();

                state.p1Name = data.p1.name; state.p2Name = data.p2.name;
                state.p1Grid = data.p1.grid; state.p2Grid = data.p2.grid;
                state.struck = data.struck || [];
                state.turn = data.turn;

                if(data.status === 'finished') endGame(data.winner);
                render();
                startTimer();
            });
        }

        function initUI() {
            showScreen('game');
            document.getElementById('name-p1').innerText = state.p1Name;
            document.getElementById('name-p2').innerText = state.p2Name;
            if(state.roomID) document.getElementById('roomDisp').innerText = "ROOM: " + state.roomID + " (TAP TO COPY)";
            render();
        }

        function render() {
            const board = document.getElementById('mainBoard');
            board.innerHTML = '';
            const grid = state.role === 'p1' ? state.p1Grid : state.p2Grid;

            grid.forEach(n => {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.innerText = n;
                const sIdx = state.struck.indexOf(n);
                if(sIdx !== -1) {
                    cell.classList.add(sIdx % 2 === 0 ? 'struck-p1' : 'struck-p2');
                }
                cell.onclick = () => play(n);
                board.appendChild(cell);
            });

            document.getElementById('turn-msg').innerText = state.turn.toUpperCase() + " TURN";
            updateHappy();
        }

        function play(n) {
            if(state.mode === 'on' && state.turn !== state.role) return;
            if(state.struck.includes(n)) return;

            const newStruck = [...state.struck, n];
            
            if(state.mode === 'off') {
                state.struck = newStruck;
                if(check(state.p1Grid, newStruck) >= 5) return endGame(state.turn);
                state.turn = state.turn === 'p1' ? 'p2' : 'p1';
                render();
            } else {
                const myGrid = state.role === 'p1' ? state.p1Grid : state.p2Grid;
                let upd = { struck: newStruck, turn: state.role === 'p1' ? 'p2' : 'p1' };
                if(check(myGrid, newStruck) >= 5) {
                    upd.status = 'finished';
                    upd.winner = state.role;
                }
                db.ref('rooms/' + state.roomID).update(upd);
            }
        }

        function check(grid, struck) {
            return winLines.filter(l => l.every(i => struck.includes(grid[i]))).length;
        }

        function updateHappy() {
            const l1 = check(state.p1Grid, state.struck);
            const l2 = check(state.p2Grid, state.struck);
            document.querySelectorAll('#happy-p1 .letter').forEach((el, i) => {
                if(i < l1) el.classList.add('active', 'p1-lit');
            });
            document.querySelectorAll('#happy-p2 .letter').forEach((el, i) => {
                if(i < l2) el.classList.add('active', 'p2-lit');
            });
        }

        function startTimer() {
            clearInterval(state.timerIdx);
            state.timer = 30;
            const bar = document.getElementById('timerBar');
            state.timerIdx = setInterval(() => {
                state.timer--;
                bar.style.width = (state.timer / 30 * 100) + "%";
                if(state.timer <= 0) {
                    clearInterval(state.timerIdx);
                    if(state.mode === 'on' && state.role === state.turn) {
                        db.ref('rooms/' + state.roomID).update({ turn: state.role === 'p1' ? 'p2' : 'p1' });
                    }
                }
            }, 1000);
        }

        function endGame(w) {
            clearInterval(state.timerIdx);
            document.getElementById('win-status').innerText = (w === 'p1' ? state.p1Name : state.p2Name) + " WINS!";
            document.getElementById('win-status').style.color = w === 'p1' ? 'var(--p1)' : 'var(--p2)';
            
            document.getElementById('rev-name-p1').innerText = state.p1Name;
            document.getElementById('rev-name-p2').innerText = state.p2Name;
            
            fillMini('rev-board-p1', state.p1Grid);
            fillMini('rev-board-p2', state.p2Grid);
            
            document.getElementById('overlay-reveal').classList.add('active');
        }

        function fillMini(id, grid) {
            const el = document.getElementById(id);
            el.innerHTML = '';
            grid.forEach(n => {
                const c = document.createElement('div');
                c.className = 'mini-cell';
                const sIdx = state.struck.indexOf(n);
                if(sIdx !== -1) c.classList.add(sIdx % 2 === 0 ? 'struck-p1' : 'struck-p2');
                c.innerText = n;
                el.appendChild(c);
            });
        }

        function handleDisconnect() {
            if(state.mode === 'on' && !document.getElementById('overlay-reveal').classList.contains('active')) {
                alert("Game Ended: Opponent left.");
                exitGame();
            }
        }

        function exitGame() {
            if(state.roomID) db.ref('rooms/' + state.roomID).remove();
            location.reload();
        }

        // Net check
        db.ref('.info/connected').on('value', snap => {
            document.getElementById('overlay-error').classList.toggle('active', snap.val() === false);
        });
    </script>
</body>
</html>