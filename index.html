<!DOCTYPE html>
<html lang="en" data-theme="neon">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-select=none">
    <title>HAPPY BINGO</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Poppins:wght@400;700&display=swap');

        :root {
            --bg: #0f172a; --card: #1e293b; --text: #f8fafc;
            --p1: #00f2ff; --p2: #ff007b; --accent: #f1c40f; --cell: #334155;
        }

        [data-theme="space"] { --bg: #1a1a2e; --card: #16213e; --text: #e94560; --p1: #4cc9f0; --p2: #e94560; --accent: #ffffff; --cell: #0f3460; }
        [data-theme="forest"] { --bg: #052c05; --card: #0a3d0a; --text: #dcfce7; --p1: #22c55e; --p2: #fbbf24; --accent: #ffffff; --cell: #14532d; }
        [data-theme="paper"] { --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --p1: #3b82f6; --p2: #ef4444; --accent: #f59e0b; --cell: #f1f5f9; }
        [data-theme="sky"] { --bg: #e0f2fe; --card: #ffffff; --text: #0369a1; --p1: #0ea5e9; --p2: #ec4899; --accent: #8b5cf6; --cell: #bae6fd; }
        [data-theme="mint"] { --bg: #f0fdf4; --card: #ffffff; --text: #166534; --p1: #10b981; --p2: #f97316; --accent: #3b82f6; --cell: #dcfce7; }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); min-height: 100vh; transition: 0.3s; touch-action: manipulation; }

        .container { width: 100%; max-width: 500px; margin: 0 auto; padding: 15px; }
        .screen { display: none; animation: fadeIn 0.3s ease; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: var(--card); padding: 20px; border-radius: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); text-align: center; }
        h1 { font-family: 'Orbitron'; font-size: clamp(1.5rem, 8vw, 2.2rem); margin-bottom: 20px; color: var(--accent); letter-spacing: 2px; }

        .btn { width: 100%; padding: 16px; margin: 8px 0; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; transition: 0.2s; text-transform: uppercase; font-size: 0.9rem; }
        .btn-p1 { background: var(--p1); color: #fff; }
        .btn-p2 { background: var(--p2); color: #fff; }
        .btn-accent { background: var(--accent); color: #000; }
        
        input, select { width: 100%; padding: 14px; margin: 8px 0; border-radius: 10px; border: 2px solid rgba(0,0,0,0.1); background: var(--cell); color: var(--text); font-size: 1rem; }

        .timer-container { width: 100%; height: 6px; background: rgba(0,0,0,0.1); border-radius: 3px; margin: 15px 0; overflow: hidden; }
        #timerBar { width: 100%; height: 100%; background: var(--accent); transition: width 1s linear; }

        .game-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .player-block { flex: 1; text-align: center; }
        .happy-letters { display: flex; gap: 3px; justify-content: center; margin-top: 5px; }
        .letter { width: 22px; height: 22px; background: rgba(0,0,0,0.2); border-radius: 4px; display: flex; align-items: center; justify-content: center; font-weight: 900; opacity: 0.1; font-size: 0.7rem; color: #fff; }
        
        .letter.active { opacity: 1; animation: drop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; color: #fff; }
        @keyframes drop { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .p1-lit { background: var(--p1) !important; box-shadow: 0 0 10px var(--p1); }
        .p2-lit { background: var(--p2) !important; box-shadow: 0 0 10px var(--p2); }

        .board { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; width: 100%; aspect-ratio: 1; }
        .cell { background: var(--cell); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.2rem; cursor: pointer; transition: 0.2s; }
        
        .cell.struck-p1 { background: var(--p1) !important; color: #fff !important; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transform: scale(0.96); }
        .cell.struck-p2 { background: var(--p2) !important; color: #fff !important; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transform: scale(0.96); }

        /* REVEAL OVERLAY */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.98); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; padding: 15px; overflow-y: auto; }
        .overlay.active { display: flex; }
        .reveal-scroll { display: flex; gap: 15px; margin: 20px 0; width: 100%; overflow-x: auto; padding: 15px; scroll-snap-type: x mandatory; }
        .reveal-card { flex: 0 0 260px; scroll-snap-align: center; text-align: center; background: var(--card); padding: 15px; border-radius: 15px; border: 2px solid transparent; }
        .mini-board { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; margin-top: 15px; }
        .mini-cell { aspect-ratio: 1; font-size: 0.8rem; background: var(--cell); border-radius: 4px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: var(--text); }
        
        .mini-cell.struck-p1 { background: var(--p1) !important; color: #fff !important; }
        .mini-cell.struck-p2 { background: var(--p2) !important; color: #fff !important; }

        .winner-glow { border-color: var(--accent) !important; box-shadow: 0 0 30px var(--accent); animation: pulse 2s infinite; transform: scale(1.05); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

        .copy-tag { font-size: 0.7rem; background: rgba(255,255,255,0.1); padding: 6px 12px; border-radius: 6px; margin-top: 10px; display: inline-block; cursor: pointer; color: var(--accent); border: 1px solid var(--accent); }
    </style>
</head>
<body data-theme="neon">

    <div class="container">
        <!-- 1. LANDING -->
        <div id="scr-landing" class="screen active">
            <div class="card">
                <h1>HAPPY BINGO</h1>
                <select id="themeSelect" onchange="setTheme(this.value)">
                    <optgroup label="Dark Themes">
                        <option value="neon">Neon Night</option>
                        <option value="space">Deep Space</option>
                        <option value="forest">Midnight Forest</option>
                    </optgroup>
                    <optgroup label="Light Themes">
                        <option value="paper">Classic Paper</option>
                        <option value="sky">Blue Sky</option>
                        <option value="mint">Fresh Mint</option>
                    </optgroup>
                </select>
                <button class="btn btn-p1" onclick="startOffline()">Offline Play</button>
                <button class="btn btn-p2" onclick="showScreen('online-name')">Online Mode</button>
            </div>
        </div>

        <!-- 2. NAME ENTRY -->
        <div id="scr-online-name" class="screen">
            <div class="card">
                <h2>Enter Name</h2>
                <input type="text" id="pName" placeholder="e.g. Water">
                <button class="btn btn-accent" onclick="confirmName()">Next</button>
                <button class="btn" onclick="showScreen('landing')">Back</button>
            </div>
        </div>

        <!-- 3. ACTION -->
        <div id="scr-online-action" class="screen">
            <div class="card">
                <h2 id="helloName">Hi!</h2>
                <button class="btn btn-p1" onclick="createRoom()">Create Room</button>
                <div style="margin: 15px 0; opacity: 0.2;">OR</div>
                <input type="text" id="inputCode" placeholder="Enter Room Code">
                <button class="btn btn-p2" onclick="joinRoom()">Join Room</button>
                <button class="btn" onclick="showScreen('online-name')">Back</button>
            </div>
        </div>

        <!-- 4. LOBBY -->
        <div id="scr-lobby" class="screen">
            <div class="card">
                <h2>Lobby</h2>
                <div style="font-size: 2.5rem; font-weight: 900; margin: 20px 0; color: var(--accent);" id="dispCode">-----</div>
                <button class="btn btn-accent" onclick="copyCode()">Copy Code</button>
                <p style="margin-top: 15px; opacity: 0.6;">Waiting for Player 2...</p>
            </div>
        </div>

        <!-- 5. GAME -->
        <div id="scr-game" class="screen">
            <div class="timer-container"><div id="timerBar"></div></div>
            <div class="game-header">
                <div class="player-block">
                    <div id="txt-p1" style="font-weight: 700; color: var(--p1); font-size: 0.75rem;">P1</div>
                    <div class="happy-letters" id="hap-p1">
                        <div class="letter">H</div><div class="letter">A</div><div class="letter">P</div><div class="letter">P</div><div class="letter">Y</div>
                    </div>
                </div>
                <div id="game-status" style="font-family: Orbitron; font-size: 0.7rem; padding-top: 8px; color: var(--accent);">READY</div>
                <div class="player-block">
                    <div id="txt-p2" style="font-weight: 700; color: var(--p2); font-size: 0.75rem;">P2</div>
                    <div class="happy-letters" id="hap-p2">
                        <div class="letter">H</div><div class="letter">A</div><div class="letter">P</div><div class="letter">P</div><div class="letter">Y</div>
                    </div>
                </div>
            </div>
            <div class="board" id="gameBoard"></div>
            <div style="text-align: center;"><div class="copy-tag" id="footCode" onclick="copyCode()"></div></div>
        </div>
    </div>

    <!-- REVEAL OVERLAY -->
    <div class="overlay" id="revealOverlay">
        <h1 id="winBanner" style="font-family: Orbitron;">WINNER!</h1>
        <div class="reveal-scroll">
            <div class="reveal-card" id="rev-card-p1">
                <p id="rev-n1" style="color: var(--p1); font-weight: bold;"></p>
                <div class="mini-board" id="rev-b1"></div>
            </div>
            <div class="reveal-card" id="rev-card-p2">
                <p id="rev-n2" style="color: var(--p2); font-weight: bold;"></p>
                <div class="mini-board" id="rev-b2"></div>
            </div>
        </div>
        <button class="btn btn-accent" onclick="location.reload()" style="max-width: 250px;">Main Menu</button>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD9TdgANtxXcp9rM8zLKBSsxWWla0y3MdY",
            authDomain: "bingo-f9c68.firebaseapp.com",
            databaseURL: "https://bingo-f9c68-default-rtdb.firebaseio.com",
            projectId: "bingo-f9c68",
            storageBucket: "bingo-f9c68.firebasestorage.app",
            messagingSenderId: "147698658087",
            appId: "1:147698658087:web:7180b36507f4e81801d702"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let game = {
            mode: 'off', role: 'p1', turn: 'p1',
            p1Name: 'Water', p2Name: 'Fire',
            p1Grid: [], p2Grid: [], struck: [],
            roomID: null, timer: 30, tIdx: null,
            finished: false
        };

        const patterns = [[0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],[0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],[0,6,12,18,24],[4,8,12,16,20]];

        function setTheme(t) { document.body.setAttribute('data-theme', t); }
        function showScreen(s) {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById('scr-' + s).classList.add('active');
        }
        function copyCode() {
            if(!game.roomID) return;
            navigator.clipboard.writeText(game.roomID);
            alert("Room Code Copied!");
        }

        function confirmName() {
            const n = document.getElementById('pName').value.trim();
            if(!n) return alert("Enter Name");
            game.p1Name = n;
            document.getElementById('helloName').innerText = "Hi, " + n + "!";
            showScreen('online-action');
        }

        function startOffline() {
            game.mode = 'off';
            game.p1Grid = [...Array(25).keys()].map(i => i+1).sort(() => Math.random() - 0.5);
            game.p2Grid = game.p1Grid;
            initUI();
        }

        function createRoom() {
            game.roomID = Math.random().toString(36).substring(2, 7).toUpperCase();
            game.role = 'p1'; game.mode = 'on';
            document.getElementById('dispCode').innerText = game.roomID;
            const g1 = [...Array(25).keys()].map(i => i+1).sort(() => Math.random() - 0.5);
            const g2 = [...Array(25).keys()].map(i => i+1).sort(() => Math.random() - 0.5);
            db.ref('rooms/' + game.roomID).set({
                p1: { name: game.p1Name, grid: g1 },
                p2: { name: "Waiting...", grid: g2 },
                struck: [], turn: 'p1', status: 'waiting'
            });
            showScreen('lobby');
            listenRoom();
        }

        function joinRoom() {
            const code = document.getElementById('inputCode').value.toUpperCase().trim();
            if(!code) return alert("Enter Code");
            db.ref('rooms/' + code).once('value', snap => {
                if(!snap.exists()) return alert("Room Not Found");
                game.roomID = code; game.role = 'p2'; game.p2Name = game.p1Name; game.mode = 'on';
                db.ref('rooms/' + code).update({ 'p2/name': game.p2Name, status: 'playing' });
                listenRoom();
            });
        }

        function listenRoom() {
            db.ref('rooms/' + game.roomID).on('value', snap => {
                const data = snap.val();
                if(!data) return;
                game.p1Name = data.p1.name; game.p2Name = data.p2.name;
                game.p1Grid = data.p1.grid; game.p2Grid = data.p2.grid;
                game.struck = data.struck || [];
                game.turn = data.turn;

                if(data.status === 'playing') {
                    if(!document.getElementById('scr-game').classList.contains('active')) initUI();
                    render();
                    startTimer();
                }
                // FIXED: Pass data.struck directly to reveal
                if(data.status === 'finished' && !game.finished) doReveal(data.winner, data.struck);
            });
        }

        function initUI() {
            showScreen('game');
            document.getElementById('txt-p1').innerText = game.p1Name;
            document.getElementById('txt-p2').innerText = game.p2Name;
            if(game.roomID) document.getElementById('footCode').innerText = "CODE: " + game.roomID;
            render();
        }

        function render() {
            const board = document.getElementById('gameBoard');
            board.innerHTML = '';
            const grid = game.role === 'p1' ? game.p1Grid : game.p2Grid;
            grid.forEach(n => {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.innerText = n;
                const idx = game.struck.indexOf(n);
                if(idx !== -1) cell.classList.add(idx % 2 === 0 ? 'struck-p1' : 'struck-p2');
                cell.onclick = () => handlePlay(n);
                board.appendChild(cell);
            });
            document.getElementById('game-status').innerText = (game.turn === game.role ? "YOUR TURN" : "THEIR TURN");
            updateHappy();
        }

        function handlePlay(n) {
            if(game.finished || (game.mode === 'on' && game.turn !== game.role) || game.struck.includes(n)) return;
            const nextStruck = [...game.struck, n];
            
            // Local update for instant feel
            game.struck = nextStruck;
            updateHappy();

            if(game.mode === 'off') {
                if(getLines(game.p1Grid, nextStruck) >= 5) return doReveal(game.turn, nextStruck);
                game.turn = game.turn === 'p1' ? 'p2' : 'p1';
                render();
            } else {
                const myGrid = game.role === 'p1' ? game.p1Grid : game.p2Grid;
                let upd = { struck: nextStruck, turn: game.role === 'p1' ? 'p2' : 'p1' };
                if(getLines(myGrid, nextStruck) >= 5) { 
                    upd.status = 'finished'; 
                    upd.winner = game.role; 
                }
                db.ref('rooms/' + game.roomID).update(upd);
            }
        }

        function getLines(grid, struck) { return patterns.filter(p => p.every(i => struck.includes(grid[i]))).length; }

        function updateHappy() {
            const l1 = getLines(game.p1Grid, game.struck);
            const l2 = getLines(game.p2Grid, game.struck);
            document.querySelectorAll('#hap-p1 .letter').forEach((el, i) => { if(i < l1) el.classList.add('active', 'p1-lit'); });
            document.querySelectorAll('#hap-p2 .letter').forEach((el, i) => { if(i < l2) el.classList.add('active', 'p2-lit'); });
        }

        function startTimer() {
            clearInterval(game.tIdx);
            game.timer = 30;
            game.tIdx = setInterval(() => {
                game.timer--;
                document.getElementById('timerBar').style.width = (game.timer / 30 * 100) + "%";
                if(game.timer <= 0) {
                    clearInterval(game.tIdx);
                    if(game.mode === 'on' && game.role === game.turn) db.ref('rooms/' + game.roomID).update({ turn: game.role === 'p1' ? 'p2' : 'p1' });
                }
            }, 1000);
        }

        // FIXED: Accepted struckList to ensure final number is included
        function doReveal(w, struckList) {
            game.finished = true;
            clearInterval(game.tIdx);
            
            // Update final local state
            game.struck = struckList;
            updateHappy();
            render();

            setTimeout(() => {
                document.getElementById('winBanner').innerText = (w === 'p1' ? game.p1Name : game.p2Name) + " WINS!";
                document.getElementById('winBanner').style.color = w === 'p1' ? 'var(--p1)' : 'var(--p2)';
                document.getElementById('rev-n1').innerText = game.p1Name;
                document.getElementById('rev-n2').innerText = game.p2Name;
                
                fillMini('rev-b1', game.p1Grid, struckList);
                fillMini('rev-b2', game.p2Grid, struckList);

                document.getElementById('rev-card-p1').classList.toggle('winner-glow', w === 'p1');
                document.getElementById('rev-card-p2').classList.toggle('winner-glow', w === 'p2');
                document.getElementById('revealOverlay').classList.add('active');
            }, 500); // 0.5s delay to see the winning move on the board
        }

        function fillMini(id, grid, finalStruck) {
            const el = document.getElementById(id);
            el.innerHTML = '';
            grid.forEach(n => {
                const c = document.createElement('div');
                c.className = 'mini-cell';
                c.innerText = n;
                const idx = finalStruck.indexOf(n);
                if(idx !== -1) c.classList.add(idx % 2 === 0 ? 'struck-p1' : 'struck-p2');
                el.appendChild(c);
            });
        }
    </script>
</body>
</html>
